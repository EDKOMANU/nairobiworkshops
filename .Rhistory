crs = 'EPSG:4326', # lat/lon
overwrite = TRUE, # overwrite if it exists
bands = list("NDVI") # only download NDVI
)
x <- rast(x) # load raster
ndviextract <- exact_extract(x, malawi, fun = "mean", append_cols = "EA_CODE")
colnames(ndviextract) <- c("EA_CODE", paste0("NDVI_", i))
adminareas <- adminareas |>
left_join(ndviextract, by = "EA_CODE")
}
adminareas
getwd()
setwd("~/Dropbox/Papers/UN-SAE/workshops/africa/nairobiworkshops")
getwd()
write_csv(adminareas, "day4data/ndviallmonths.csv")
#| eval: false
#| echo: true
#| code-fold: true
#| class-output: hscroll
ndviall <- read_csv("day4data/ndviallmonths.csv")
ndviall
ndviall$min <- apply(ndviall |> select(starts_with("NDVI")), 1, min, na.rm = TRUE)
# max
ndviall$max <- apply(ndviall |> select(starts_with("NDVI")), 1, max, na.rm = TRUE)
# mean
ndviall$mean <- apply(ndviall |> select(starts_with("NDVI")), 1, mean, na.rm = TRUE)
ndviall
#| eval: true
#| echo: true
#| code-fold: true
#| class-output: hscroll
ndviall <- read_csv("day4data/ndviallmonths.csv")
#| eval: true
#| echo: true
#| code-fold: true
#| class-output: hscroll
# create new variable called min. the "1" means across ROWS.
ndviall$ndvimin <- apply(ndviall |> select(starts_with("NDVI")), 1, min, na.rm = TRUE)
# max
ndviall$ndvimax <- apply(ndviall |> select(starts_with("NDVI")), 1, max, na.rm = TRUE)
# mean
ndviall$ndvimean <- apply(ndviall |> select(starts_with("NDVI")), 1, mean, na.rm = TRUE)
# just keep those
ndviall <- ndviall |>
select(EA_CODE, ndvimin, ndvimax, ndvimean)
ndviall
summary(ndviall)
ihs5 <- read_csv("day4data/ihs5_consumption_aggregate.csv")
ihs5 <- read_dta("day4data/ihs5_consumption_aggregate.dta")
ihs5
ihs5 <- read_dta("day4data/ihs5_consumption_aggregate.dta")
ihs5
?weighted.mean
#| eval: true
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
#| eval: true
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
head(ihs5coords)
admin4 <- read_sf("day4data/mw4.shp")
# turn it into an sf object
ihs5coords <- ihs5coords |>
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
#| eval: true
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
head(ihs5coords)
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
head(ihs5coords)
#| eval: true
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
#| eval: true
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
ggplot() +
geom_sf(admin4, color = "transparent", lwd = 0.01) +
geom_sf(ihs5coords, color = "red") +
theme_minimal()
ihs5coords
ggplot() +
geom_sf(data = admin4, color = "transparent", lwd = 0.01) +
geom_sf(data = ihs5coords, color = "red") +
theme_minimal()
#| echo: false
#| include: true
#| fig-align: center
admin2 <- read_sf("day4data/mw2.shp")
admin3 <- read_sf("day4data/mw3.shp")
admin3 <- st_transform(admin3, crs = st_crs(admin2))
survey <- read_dta("day4data/householdgeovariables_ihs5.dta")
survey$DIST_CODE <- substr(survey$EA_CODE, 1, 3)
#| echo: false
#| include: true
#| fig-align: center
admin2 <- read_sf("day4data/mw2.shp")
admin3 <- read_sf("day4data/mw3.shp")
admin3 <- st_transform(admin3, crs = st_crs(admin2))
survey <- read_dta("day4data/householdgeovariables_ihs5.dta")
survey$DIST_CODE <- substr(survey$EA_CODE, 1, 3)
survey
survey$DIST_CODE <- substr(survey$case_id, 1, 3)
survey$TA_CODE <- substr(survey$case_id, 1, 5)
temp <- survey |>
group_by(DIST_CODE) |>
summarise(n = n())
admin2 <- admin2 |>
left_join(temp, by = "DIST_CODE")
temp <- survey |>
group_by(TA_CODE) |>
summarise(n = n())
admin3 <- admin3 |>
left_join(temp, by = "TA_CODE")
admin3$n[is.na(admin3$n)] <- 0
g1 <- ggplot() +
geom_sf(data = admin2, aes(fill = n), color = NA, lwd = 0.001) +
scale_fill_distiller("Observations", palette = "Spectral") +
theme_bw() +
labs(subtitle = "District (admin2)")
g2 <- ggplot() +
geom_sf(data = admin3, aes(fill = n), color = NA, lwd = 0.001) +
scale_fill_distiller("Observations", palette = "Spectral") +
theme_bw() +
labs(subtitle = "TA (admin3)")
# extract the legend from one of the plots
legend <- ggpubr::get_legend(g1 +
# horizontal legend
guides(color = guide_legend(nrow = 1)) +
theme(legend.position = "bottom"))
grid <- plot_grid(g1 + theme(legend.position = "none"), g2 + theme(legend.position = "none"), ncol = 2)
plot_grid(grid, legend, ncol = 1, rel_heights = c(1, 0.1))
?weighted.mean
#| eval: true
#| echo: true
#| code-fold: show
library(stats) # this is for weighted.mean
ihs5ea <- ihs5 |>
rename(EA_CODE = ea_id) |>
group_by(EA_CODE) |>
# Note that this is a weighted mean!
summarize(poor = stats::weighted.mean(poor, wt = hh_wt*adulteq, na.rm = TRUE), # weighted mean
total_weights = sum(hh_wt*adulteq, na.rm = TRUE), # sum total weights
total_obs = n()) # total observations (households) in the EA
ihs5 <- read_dta("day4data/ihs5_consumption_aggregate.dta")
ihs5
ihs5ea <- ihs5 |>
rename(EA_CODE = ea_id) |>
group_by(EA_CODE) |>
# Note that this is a weighted mean!
summarize(poor = stats::weighted.mean(poor, wt = hh_wgt*adulteq, na.rm = TRUE), # weighted mean
total_weights = sum(hh_wgt*adulteq, na.rm = TRUE), # sum total weights
total_obs = n()) # total observations (households) in the EA
head(ihs5ea)
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
head(ihs5coords)
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
head(ihs5coords)
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
admin4
?stats::weighted.mean
ihs5ea <- ihs5 |>
rename(EA_CODE = ea_id) |>
group_by(EA_CODE) |>
# Note that this is a weighted mean!
summarize(poor = stats::weighted.mean(x = poor, w = hh_wgt*adulteq, na.rm = TRUE), # weighted mean
total_weights = sum(hh_wgt*adulteq, na.rm = TRUE), # sum total weights
total_obs = n()) # total observations (households) in the EA
#| eval: false
#| echo: true
#| code-fold: show
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
ggplot() +
geom_sf(data = admin4, color = "transparent", lwd = 0.01) +
geom_sf(data = ihs5coords, color = "red") +
theme_minimal()
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
ggplot() +
geom_sf(data = admin4, color = "transparent", lwd = 0.01) +
geom_sf(data = ihs5coords, color = "red") +
theme_minimal()
ihs5coords <- read_dta("day4data/householdgeovariables_ihs5.dta")
# turn it into an sf object
ihs5coords <- ihs5coords |>
filter(!is.na(ea_lon_mod)) |> # get rid of any missing values (can't use them)
st_as_sf(coords = c("ea_lon_mod", "ea_lat_mod"), crs = 4326)
admin4 <- read_sf("day4data/mw4.shp")
ihs5coords <- st_join(ihs5coords, admin4)
head(ihs5coords)
st_extent(admin4)
raster::extent(admin4)
temp <- read_csv("/Users/Josh/Downloads/Mosaiks_features.csv")
head(temp)
temp <- temp[,-c("BoxLabel")]
temp <- temp |> dplyr::select(-c("BoxLabel"))
temp
temp
?rast
# use Lat/Lon to create point feature
temp <- temp |>
st_as_sf(coords = c("Lon", "Lat"), crs = 4326)
temp
colnames(temp)[1:(length(colnames(temp))-1)] <- paste0("var", 1:(length(colnames(temp))-1))
colnames(temp)
temp <- st_join(temp, admin4)
temp <- temp |>
group_by(EA_CODE) |>
summarize(across(starts_with("var"), mean, na.rm = TRUE))
temp
object.size(temp)
write_csv(temp, "day4data/mosaikvars.csv")
for (i in ncol(temp):2){
if (sd(temp[,i]==0)){
temp <- temp[,-i]
}
}
temp
dim(temp)
sd(temp[,i])
sd(as_vector(temp[,i]))
temp[,i]
temp <- as_tibble(temp) |> dplyr::select(-geometry)
temp
temp[,i]
temp[,i-1]
i = ncol(temp)
sd(temp[,i])
temp[,i]
sd(as_vector(temp[,i]))
for (i in ncol(temp):2){
if (sd(as_vector(temp[,i]))==0){
temp <- temp[,-i]
}
}
dim(temp)
saveRDS(temp, "day4data/mosaikvars.rds")
for (i in ncol(temp):2){
if (sd(as_vector(temp[,i]))<=0.0001){
temp <- temp[,-i]
}
}
dim(temp)
# randomcols
temp <- temp[,sample(ncol(temp), 500)]
temp
write_csv(temp, "day4data/mosaikvars.csv")
#| label: setup
#| include: false
widthdefault <- getOption("width")
options(width = 1500)
library(tidyverse)
library(sf)
library(cowplot)
library(haven)
library(terra)
library(tidyterra)
library(exactextractr)
Sys.setenv("RETICULATE_PYTHON" = "~/Library/r-miniconda-arm64/envs/RGEEDIM/bin/python3.9")
library(rgeedim)
# short duration token
gd_authenticate(auth_mode = "gcloud")
# initialize and should be good to go
gd_initialize()
library(tidyverse)
library(tidyverse)
surveycollapsed <- read_csv("day3data/ihs5ea.csv")
predictors <- read_csv("day3data/mosaikvars.csv")
surveycollapsed
#| label: setup
#| include: false
widthdefault <- getOption("width")
options(width = 1500)
library(tidyverse)
library(sf)
library(cowplot)
library(haven)
library(terra)
library(tidyterra)
library(exactextractr)
#| echo: false
#| include: true
#| fig-align: center
adm4 <- read_sf("day3data/mw4.shp")
adm4 <- adm4 |>
left_join(surveycollapsed, by = "EA_CODE")
adm4 <- adm4 |>
mutate(EA_CODE = as.numeric(EA_CODE))
adm4 <- adm4 |>
mutate(EA_CODE = as.numeric(EA_CODE)) |>
left_join(surveycollapsed, by = "EA_CODE")
adm4
adm4$insample <- "No"
adm4$insample[!is.na(adm4$poor)] <- "Yes"
table(adm4$insample)
ggplot() +
geom_df(data = adm4, aes(fill = insample), color = "transparent", lwd = 0.01) |>
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "transparent", lwd = 0.01) |>
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "transparent", lwd = 0.01) |>
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) |>
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) |>
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Set1") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Set2") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Accent") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Accent") +
theme_minimal()
ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_minimal()
g1 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_minimal() +
theme(legend.position = "bottom")
ggsave(g1, "day3assets/surveyexample.png")
?ggsave
ggsave("day3assets/surveyexample.png", plot = g1)
g1 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
theme(legend.position = "bottom")
ggsave("day3assets/surveyexample.png", plot = g1)
ggsave("day3assets/surveyexample.png", plot = g1, dpi = 500)
#| echo: false
#| include: false
#| fig-align: center
adm3 <- read_sf("day3data/mw3.shp")
adm3
surveycollapsed
surveyTA <- surveycollapsed |>
mutate(TA_CODE = substr(EA_CODE, 1, 5)) |>
group_by(TA_CODE) |>
summarize(poor = weighted.mean(poor, total_weights, na.rm = TRUE),
total_obs = sum(total_obs, na.rm = TRUE)) |>
ungroup()
surveyTA
adm3 <- adm3 |>
left_join(surveyTA, by = "TA_CODE")
adm3
adm3$insample <- "No"
adm3$insample[!is.na(adm3$poor)] <- "Yes"
g1 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
theme(legend.position = "bottom")
ggsave("day3assets/surveyexample.png", plot = g1, dpi = 500) # (did this once, don't do it again)
g1 <- ggplot() +
geom_sf(data = adm3, aes(fill = insample), color = "white", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
theme(legend.position = "bottom")
ggsave("day3assets/surveyexample.png", plot = g1, dpi = 500) # (did this once, don't do it again)
g1 <- ggplot() +
geom_sf(data = adm3, aes(fill = insample), color = "black", lwd = 0.1) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
theme(legend.position = "bottom")
ggsave("day3assets/surveyexample.png", plot = g1, dpi = 500) # (did this once, don't do it again)
#| echo: false
#| include: false
#| fig-align: center
adm4 <- read_sf("day3data/mw4.shp")
adm4 <- adm4 |>
mutate(EA_CODE = as.numeric(EA_CODE)) |>
left_join(surveycollapsed, by = "EA_CODE")
adm4$insample <- "No"
adm4$insample[!is.na(adm4$poor)] <- "Yes"
adm4
adm3 <- read_sf("day3data/mw3.shp")
surveyTA <- surveycollapsed |>
mutate(TA_CODE = substr(EA_CODE, 1, 5)) |>
group_by(TA_CODE) |>
summarize(poor = weighted.mean(poor, total_weights, na.rm = TRUE),
total_obs = sum(total_obs, na.rm = TRUE)) |>
ungroup()
adm3 <- adm3 |>
left_join(surveyTA, by = "TA_CODE")
adm3$insample <- "No"
adm3$insample[!is.na(adm3$poor)] <- "Yes"
g1 <- ggplot() +
geom_sf(data = adm3, aes(fill = insample), color = "black", lwd = 0.1) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "A. TA (area) level") +
theme(legend.position = "bottom")
g2 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "black", lwd = 0.1) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "B. EA (subarea) level") +
theme(legend.position = "bottom")
ggarrange(g1, g2, common.legend = TRUE)
library(ggpubr)
ggarrange(g1, g2, common.legend = TRUE)
ggarrange(g1, g2, common.legend = TRUE, legend = "bottom")
g1 <- ggplot() +
geom_sf(data = adm3, aes(fill = insample), color = "black", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "A. TA (area) level") +
theme(legend.position = "bottom")
g2 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "black", lwd = 0.01) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "B. EA (subarea) level") +
theme(legend.position = "bottom")
ggarrange(g1, g2, common.legend = TRUE, legend =)
ggarrange(g1, g2, common.legend = TRUE, legend = "bottom")
plot_grid(g1, g2, ncol = 2)
plot_grid(g1, g2, ncol = 2)
?plot_grid
g1 <- ggplot() +
geom_sf(data = adm3, aes(fill = insample), color = "black", lwd = 0.1) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "A. TA (area) level") +
theme(legend.position = "bottom")
g2 <- ggplot() +
geom_sf(data = adm4, aes(fill = insample), color = "black", lwd = 0.001) +
scale_fill_brewer("Have sample\nobservations?", palette = "Spectral") +
theme_bw() +
labs(subtitle = "B. EA (subarea) level") +
theme(legend.position = "none")
g2
# get the legend
g1legend <- get_legend(g1)
g1new <- plot_grid(g1 + theme(legend.position = "none"), g2, ncol = 2)
plot_grid(g1new, g1legend, ncol = 1, rel_heights = c(1, 0.1))
plot_grid(g1new, g1legend, ncol = 1, rel_heights = c(1, 0.1))
#| echo: true
#| include: true
#| class-output: hscroll
predictors
sum(is.na(predictors))
predictors
predictors[is.na(predictors)]
summary(predictors$EA_CODE)
predictors <- read_csv("day3data/mosaikvars.csv")
predictors <- predictors |> filter(!is.na(EA_CODE))
write_csv(predictors, "day3data/mosaikvars.csv")
library(tidyverse)
surveycollapsed <- read_csv("day3data/ihs5ea.csv")
predictors <- read_csv("day3data/mosaikvars.csv")
summary(predictors)
